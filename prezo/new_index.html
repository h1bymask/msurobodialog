<html>
	<head>
		<meta charset="utf-8">
		<style type="text/css">
			    object, img { 
					position: absolute; 
					left: 0; 
					height: 100%; 
					width: 100%; 
				}
				body {
					overflow-y: hidden;
				}
		</style>
		<!--<script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>-->
		<script src="brython-3.10.5.min.js"></script>
		<script src="brython_stdlib-3.10.5.js"></script>
	</head>
	<body>		
		<script type="text/javascript">
			let body = document.getElementsByTagName("body")[0];
			let img = document.createElement("img");  //("object");
			let articulation_img = document.createElement("img");  //("object");
			let key_pressed_earlier = "";
			let svg_in_progress = null;
			let playback_in_progress = null;
			let articulation_in_progress = null;
			let	key_subscriptions = new Map();
			document.addEventListener("keypress", (keyboardEvent) => {
				let key = keyboardEvent.code;
				if (key_subscriptions.has(key))
					document.dispatchEvent(key_subscriptions.get(key));
			});
			async function timeout(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
			}
			img.type = "image/svg+xml";
			articulation_img.type = "image/svg+xml";
			for (let tag of body.children)
				if (tag.tagName.toLowerCase() != "script")
					body.removeChild(tag);
			body.appendChild(img);
			body.appendChild(articulation_img);
			function slide(src) {
				img.src = src;
			}
			current_slide = () => img.src;
			async function articulation(ms, src) {  // Usage: await window.articulation()
				if (articulation_in_progress != null) {
					await articulation_in_progress;
					articulation_in_progress = null;
				}
				//console.log("Setting articulation to " + src + " for " + ms + " ms");
				articulation_img.src = src;
				duration = ms;
				if (duration != null)
					articulation_in_progress = timeout(duration);
			}
			async function articulation2(src) {  // TODO
				if (svg_in_progress != null) {
					let progress = svg_in_progress;
					svg_in_progress = null;
					await progress;
				}
				articulation_img.data = src;
				//svg_in_progress = new Promise(resolve => articulation_img.addEventListener("endEvent", resolve, { once: true }));
				await new Promise(resolve => articulation_img.addEventListener("load", resolve));
				if (articulation_img.contentDocument != null) {
					let svg = articulation_img.contentDocument;
					console.log('svg:');console.log(svg);
					console.log(svg.evaluate('count(//animate)', svg).numberValue);
					let svg1 = articulation_img.getSVGDocument();
					console.log('svg1:');console.log(svg1);
					console.log(document.querySelectorAll("svg"));
					if (svg != null) {
						let animation = svg.getElementsByTagName("animate").at(-1);  // last
						if (animation != null)
							animation.addEventListener("endEvent", () => alert("end"));
					}
				}
			}
			function play(src) {
				let audio_object = new Audio(src);
				audio_object.addEventListener('loadeddata', () => console.log("Фраза " + src + ": продолжительность аудио " + Math.round(audio_object.duration*1000) + " мс"), { once: true })
				playback_in_progress = new Promise(resolve => {
					audio_object.play();
					audio_object.onended = resolve;
				});
			}
			async function wait_audio() {  // Usage: await window.wait_audio()
				if (playback_in_progress != null) {
					await playback_in_progress;
					playback_in_progress = null;
				}
			}
			async function press_key() {  // Usage: key_code_string = (await window.key()).code
				return new Promise(resolve => document.addEventListener("keydown", resolve, { once: true }));
			}
			async function wait_key(key) {
				if (key == null || key === "") {
					console.log("Waiting for any key");
					return press_key();
				}
				console.log("Waiting for '" + key + "' key");
				if (!key_subscriptions.has(key))
					key_subscriptions.set(key, new Event("CustomEvent"+key));
				return new Promise(resolve => document.addEventListener("CustomEvent"+key, resolve, { once: true }));
			}
			// Brython: document.bind("keydown", on_press_key) calls on_press_key(key) where KeyboardEvent is key having the .code field
			(async()=>{
				response = await fetch("main.py");
				code = `<script type="text/python">
from browser import window, aio
async def main():
`  + (await response.text())
					.replace(/^/gm, "\t ")
					.replace(/(\s)slide\(/g,'$1window.slide(')
					.replace(/(\s)articulation\(/g,'$1await window.articulation(')
					.replace(/(\s)play\(/g,'$1window.play(')
					.replace(/(\s)audio\(/g,'$1window.wait_audio(')
					.replace(/([^a-zA-Z_0-9])key\(/g,'$1window.wait_key(')
					+ `
aio.run(main())
`;
				let script = body.insertAdjacentHTML('beforeend', code);
				brython();
			})();
		</script>
	</body>
</html>
