<html>
	<head>
		<meta charset="utf-8">
		<style type="text/css">
			    object, img { 
					position: absolute; 
					left: 0; 
					height: 100%; 
					width: 100%; 
				} 
		</style>
	</head>
	<body>
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		<slide src="лого_персиковый.svg"><waitkeyboard>
		
			<slide src="slides/нейтральный1.svg">
		<play src="speech/можете забрать завтрак, приятного аппетита.wav">
		<articulation ms="82" src="articulation/нейтрзакр.svg">
		<articulation ms="14" src="articulation/нейтрзакр-нейрполуоткр.svg">
		<articulation ms="68" src="articulation/нейтральный1(полуоткрытый_рот).svg">
		<articulation ms="14" src="articulation/нейтрполуоткр-злойоткр.svg">
		<articulation ms="27" src="articulation/нейтральный2(открытый_рот).svg">
		<articulation ms="14" src="articulation/злойоткр-нейрполуоткр.svg">
		<articulation ms="27" src="articulation/нейтральный1(полуоткрытый_рот).svg">
		<articulation ms="14" src="articulation/нейтр-полуоткрытый-закрытый.svg">
		<articulation ms="27" src="articulation/нейтрзакр.svg">
		<articulation ms="82" src="articulation/нейтрзакр.svg">
		<articulation ms="14" src="articulation/нейтрзакр-нейрполуоткр.svg">
		<articulation ms="68" src="articulation/нейтральный1(полуоткрытый_рот).svg">
		<articulation ms="14" src="articulation/нейтрполуоткр-злойоткр.svg">
		<articulation ms="27" src="articulation/нейтральный2(открытый_рот).svg">
		<articulation ms="14" src="articulation/злойоткр-нейрполуоткр.svg">
		<articulation ms="27" src="articulation/нейтральный1(полуоткрытый_рот).svg">
		<articulation ms="14" src="articulation/нейтр-полуоткрытый-закрытый.svg">
		<articulation ms="27" src="articulation/нейтрзакр.svg">
		<articulation ms="82" src="articulation/нейтрзакр.svg">
		<articulation ms="14" src="articulation/нейтрзакр-нейрполуоткр.svg">
		<articulation ms="68" src="articulation/нейтральный1(полуоткрытый_рот).svg">
		<articulation ms="14" src="articulation/нейтрполуоткр-злойоткр.svg">
		<articulation ms="27" src="articulation/нейтральный2(открытый_рот).svg">
		<articulation ms="14" src="articulation/злойоткр-нейрполуоткр.svg">
		<articulation ms="27" src="articulation/нейтральный1(полуоткрытый_рот).svg">
		<articulation ms="14" src="articulation/нейтр-полуоткрытый-закрытый.svg">
		<articulation ms="27" src="articulation/нейтрзакр.svg">
		<waitkeyboard>
		
		<slide src="slides/слайд1.svg"><waitkeyboard>
		
		<slide src="slides/нейтральный1.svg">
		<play src="speech/выберите, что вам нужно сделать.wav">
		<articulation ms="500" src="articulation/нейтрзакр-нейтрполуоткр.svg">
		<articulation ms="500" src="articulation/нейтр-полуоткрытый-закрытый.svg">
 		<waitkeyboard>
		
		<articulation src="пусто.svg">
		<slide src="slides/слайд3.svg">
 		<waitkeyboard>
		
		<slide src="slides/слайд5.svg">
		<play src="speech/приложите палец.wav"><stop>
 		<waitkeyboard>
		
		<slide src="slides/злой.svg">
		<play src="speech/можете забрать лекарства.wav">
		<articulation ms="500" src="articulation/нейтрзакр-нейтрполуоткр.svg">
		<articulation ms="500" src="articulation/нейтр-полуоткрытый-закрытый.svg">
		<waitkeyboard>

		<articulation src="пусто.svg">
		<slide src="slides/слайд7.svg">
 	
		<slide src="slides/злой.svg">
		<play src="speech/выберите, что вы хотите сделать.wav">
		<articulation ms="500" src="articulation/нейтрзакр-нейтрполуоткр.svg">
		<articulation ms="500" src="articulation/нейтр-полуоткрытый-закрытый.svg">
 		
		<articulation src="пусто.svg">
		<slide src="slides/слайд9.svg">
 		<waitkeyboard>
		
		<slide src="slides/нейтральный1.svg">
		<play src="speech/можете забрать завтрак, приятного аппетита.wav">
		<articulation ms="500" src="articulation/нейтрзакр-нейтрполуоткр.svg">
		<articulation ms="500" src="articulation/нейтр-полуоткрытый-закрытый.svg">
		
		<articulation src="пусто.svg">
		<slide src="slides/слайд11.svg">
 		<waitkeyboard>
		
		<slide src="slides/грустный.svg">
		<play src="speech/выберите, что вы хотите сделать.wav">
		<articulation ms="500" src="articulation/нейтрзакр-нейтрполуоткр.svg">
		<articulation ms="500" src="articulation/нейтр-полуоткрытый-закрытый.svg">
		
		<articulation src="пусто.svg">
		<slide src="slides/слайд13.svg">
 		<waitkeyboard>
		
		<slide src="slides/злой.svg">
		<play src="speech/выберите, что вам нужно сделать.wav">
		<articulation ms="500" src="articulation/нейтрзакр-нейтрполуоткр.svg">
		<articulation ms="500" src="articulation/нейтр-полуоткрытый-закрытый.svg">
 		
		<articulation src="пусто.svg">
		<slide src="slides/слайд15.svg">
		<waitkeyboard>
		
		<slide src="slides/нейтральный1.svg">
		<play src="speech/выберите, что вам нужно сделать.wav">
		<articulation ms="500" src="articulation/нейтрзакр-нейтрполуоткр.svg">
		<articulation ms="500" src="articulation/нейтр-полуоткрытый-закрытый.svg">
		<waitkeyboard>
		
		<slide src="slides/грустный.svg">
		<play src="speech/media8.wav">
		<articulation ms="500" src="articulation/нейтрзакр-нейтрполуоткр.svg">
		<articulation ms="500" src="articulation/злой-открытый-закрытый.svg">
		
		<articulation src="пусто.svg">
		<slide src="slides/слайд19.svg">
		<waitkeyboard>
		
		<slide src="slides/нейтральный1.svg">
		<play src="speech/media10.wav">
		<articulation ms="82" src="articulation/нейтрзакр.svg">
		<articulation ms="14" src="articulation/нейтрзакр-нейрполуоткр.svg">
		<articulation ms="68" src="articulation/нейтральный1(полуоткрытый_рот).svg">
		<articulation ms="14" src="articulation/нейтрполуоткр-злойоткр.svg">
		<articulation ms="27" src="articulation/нейтральный2(открытый_рот).svg">
		<articulation ms="14" src="articulation/злойоткр-нейрполуоткр.svg">
		<articulation ms="27" src="articulation/нейтральный1(полуоткрытый_рот).svg">
		<articulation ms="14" src="articulation/нейтр-полуоткрытый-закрытый.svg">
		<articulation ms="27" src="articulation/нейтрзакр.svg">
		<waitkeyboard>
		
		<articulation src="пусто.svg">
		<slide src="slides/слайд21.svg">

		<articulation src="пусто.svg">
		<slide src="slides/слайд22.svg">
		<waitkeyboard>
		
		<articulation src="пусто.svg">
		<slide src="slides/слайд23.svg">
		<waitkeyboard>
		
		<slide src="slides/грустный.svg">
		<play src="speech/изменения сохранены.wav">
		<articulation ms="500" src="articulation/нейтрзакр-нейтрполуоткр.svg">
		<articulation ms="500" src="articulation/нейтр-полуоткрытый-закрытый.svg">
		
		<articulation src="пусто.svg">
		<slide src="slides/слайд25.svg">
		<waitkeyboard> 
<!--
		<articulation ms="500" src="нейтрзакр.svg">
		<articulation ms="500" src="злойоткр-нейрполуоткр.svg"><waitkeyboard>
		<articulation ms="500" src="нейтрполуоткр-злойоткр.svg"><waitkeyboard>
		<articulation ms="500" src="злой-открытый-закрытый.svg"><waitkeyboard>
		<articulation ms="500" src="злойоткр-нейрполуоткр.svg"><waitkeyboard>
		<articulation ms="500" src="нейтрзакр-нейтрполуоткр.svg"><waitkeyboard>
		<articulation ms="500" src="нейтр-полуоткрытый-закрытый.svg">
-->






























		<script type="text/javascript">
			let body = document.getElementsByTagName("body")[0];
			let sequence = body.querySelectorAll("*");
			let img = document.createElement("img");//("object");
			let articulation = document.createElement("img");//("object");
			let key_pressed = false;
			let svg_in_progress = null;
			let playback_in_progress = null;
			let articulation_in_progress = null;
			window.addEventListener("keypress", () => key_pressed = true);
			async function waitkeyboard() {
				if (!key_pressed)
					await new Promise(resolve => window.addEventListener("keypress", resolve, { once: true }));
				key_pressed = false;
			}
			async function playAudio(audio) {
				return new Promise(resolve => { audio.play(); audio.onended = resolve; });
			}
			async function timeout(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
			}
			(async function main() {
				img.type = "image/svg+xml";
				articulation.type = "image/svg+xml";
				for (let tag of body.children)
					if (tag.tagName.toLowerCase() != "script")
						body.removeChild(tag);
				body.appendChild(img);
				body.appendChild(articulation);
				for (let tag of sequence)
					switch (tag.tagName.toLowerCase()) {
						case "slide":
							img.src = tag.getAttribute("src");
							break;
						case "articulation":
							if (articulation_in_progress != null) {
								console.log('waiting for previous articulation to finish...');
								await articulation_in_progress;
								articulation_in_progress = null;
								console.log('...done');
							}
							articulation.src = tag.getAttribute("src");
							duration = tag.getAttribute("ms");
							if (duration != null)
								articulation_in_progress = timeout(duration);
							break;
						case "articulation2":  // TODO
							if (svg_in_progress != null) {
								let progress = svg_in_progress;
								svg_in_progress = null;
								await progress;
							}
							articulation.data = tag.getAttribute("src");
							//svg_in_progress = new Promise(resolve => articulation.addEventListener("endEvent", resolve, { once: true }));
							await new Promise(resolve => articulation.addEventListener("load", resolve));
							if (articulation.contentDocument != null) {
								let svg = articulation.contentDocument;
								console.log('svg:');console.log(svg);
								console.log(svg.evaluate('count(//animate)', svg).numberValue);
								let svg1 = articulation.getSVGDocument();
								console.log('svg1:');console.log(svg1);
								console.log(document.querySelectorAll("svg"));
								if (svg != null) {
									let animation = svg.getElementsByTagName("animate").at(-1);  // last
									if (animation != null)
										animation.addEventListener("endEvent", () => alert("end"));
								}
							}
							break;
						case "play":
							playback_in_progress = playAudio(new Audio(tag.getAttribute("src")));
							break;
						case "stop":
							if (playback_in_progress != null) {
								await playback_in_progress;
								playback_in_progress = null;
							}
							break;
						case "waitkeyboard":
							await waitkeyboard();
							break;
					}
			})();
		</script>
	</body>
</html>
